---
title: "ã€Kotlinã€‘Android ã§å„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç·å®¹é‡ã€ç©ºãå®¹é‡ã‚’å–å¾—ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ“Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Android", "Kotlin"]
published: true
publication_name: "no4_dev"
---

Android 10(Q)ã‹ã‚‰å°å…¥ã•ã‚ŒãŸ Scoped Storage ã®å½±éŸ¿ã§ã€ä»¥å‰ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®¹é‡é–¢é€£ã®å–å¾—ãŒã§ããªããªã£ã¦ã„ãŸãŸã‚ã€Android 10 ä»¥é™ã§ã‚‚åˆ©ç”¨ã§ãã‚‹æ–¹æ³•ã‚’æ¨¡ç´¢ã—ãŸã®ã§ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚
â€» ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¯ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’å–ã‚Œã°ã§ãã¾ã™ãŒã€
ã€€å®¹é‡é–¢é€£ã®æƒ…å ±ã‚’å–ã‚‹ãŸã‚ã ã‘ã«ã€ãƒ¦ãƒ¼ã‚¶ã«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨±å¯ã‚’æ±‚ã‚ãŸããªã‹ã£ãŸãŸã‚ã€
ã€€ StatFs ã‚’ç”¨ã„ãŸæ–¹æ³•ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚

ãªãŠã€å‹¢ã„ã§æ›¸ã„ãŸã®ã§ã€å®Ÿéš›ã«ã¯å‹•ã‹ã—ã¦ãªã„ã§ã™ã€‚ã€‚ã€‚
â€»ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®ä»–ã«å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å–å¾—ãŒå¿…è¦ãªå¯èƒ½æ€§ã‚ã‚Šã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

```Kotlin:MainActivity.kt
package com.example.storage.ui

import android.annotation.SuppressLint
import android.os.Build
import android.os.Bundle
import android.os.StatFs
import android.os.storage.StorageManager
import android.os.storage.StorageVolume
import android.util.Log
import androidx.appcompat.app.AppCompatActivity
import java.util.*

/**
 * Main Activity
 */
class MainActivity : AppCompatActivity() {
  /**
   * ==============================================
   *  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°
   * ==============================================
   */
  /** ã‚¿ã‚° */
  private val tag: String = "MainActivity"

  /** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ */
  private val storageManager: StorageManager?
    get() = getSystemService(StorageManager::class.java)

  /**
   * ==============================================
   *  ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
   * ==============================================
   */
  /**
   * onCreate
   */
  @SuppressLint("DiscouragedPrivateApi")
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    Log.i(tag, "onCreate")

    for (storageVolume: StorageVolume in storageManager!!.storageVolumes) {
      // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€1ä»¶ã¥ã¤å‡¦ç†
      // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‹ã‚‰çµ¶å¯¾ãƒ‘ã‚¹ã‚’å–å¾—
      val path: String = when {
        Build.VERSION.SDK_INT>= Build.VERSION_CODES.R -> {
          // Android 11ä»¥é™
          storageVolume.directory?.absolutePath
        }
        else -> {
          // Android 10ä»¥å‰
          // NOTE: Android10ä»¥å‰ã§ã¯getPathãŒprivateãªãŸã‚ç„¡ç†ã‚„ã‚Šå®Ÿè¡Œã—ã¦å–å¾—
          val getPath = StorageVolume::class.java.getDeclaredMethod("getPath")
          getPath.invoke(storageVolume) as String?
        }
      } ?: continue // çµ¶å¯¾ãƒ‘ã‚¹ãŒå–å¾—ã§ããªã„å ´åˆã¯ã€ã‚¹ã‚­ãƒƒãƒ—

      val statFs = StatFs(path)
      // ç·å®¹é‡
      val totalSpase: Long = statFs.blockCountLong * statFs.blockSizeLong / 1024L / 1024L
      // ç©ºãå®¹é‡
      val freeSpase: Long = statFs.availableBlocksLong * statFs.blockSizeLong / 1024L / 1024L
      // ä½¿ç”¨å®¹é‡
      val usedSpase: Long = totalSpase - freeSpase

      Log.d(tag, "Path: $path")
      Log.d(tag, " Used space: ${String.format(Locale.US, "%,12d", usedSpase)}MB")
      Log.d(tag, " Free space: ${String.format(Locale.US, "%,12d", freeSpase)}MB")
      Log.d(tag, "Total space: ${String.format(Locale.US, "%,12d", totalSpase)}MB")
      Log.d(tag, "Total space: ${String.format(Locale.US, "%,12d", totalSpase)}MB")
    }
  }
}

```

## å®Ÿè¡Œçµæœ

```sh:Log
 Path: /storage/emulated/0
  Used space:          495MB
  Free space:        5,455MB
 Total space:        5,951MB
 Path: /storage/1200-3709
  Used space:            0MB
  Free space:          509MB
 Total space:          509MB
```
