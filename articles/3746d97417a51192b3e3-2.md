---
title: "ã€Kotlinã€‘Navigation Architecture Componentã§å®‰å…¨ã«é·ç§»ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ“Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Android", "Kotlin", "NavigationComponent"]
published: true
publication_name: "no4_dev"
---

ã“ã®è¨˜äº‹ã¯[Kotlin Advent Calendar 2020](https://qiita.com/advent-calendar/2020/kotlin)ã® 4 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
Android ã‚¢ãƒ—ãƒªé–‹ç™ºåˆå¿ƒè€…ã§ã™ãŒã€ç©ºããŒã‚ã£ãŸã®ã§å‹¢ã„ã ã‘ã§å‚åŠ ã—ã¦ã¿ã¾ã—ãŸã€‚

## ã¯ã˜ã‚ã«

[Navigation Architecture Component](https://developer.android.com/guide/navigation?hl=ja)ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ãŸéš›ã€
ç´ æ—©ãæ“ä½œã—ãŸå ´åˆã‚„æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®é€£æ‰“ãªã©ã§ã€NavController ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ Fragment ãŒã‚ºãƒ¬ã¦ã—ã¾ã„ã€ã‚¨ãƒ©ãƒ¼(`IllegalArgumentException`)ãŒé »ç™ºã—ã¾ã—ãŸã€‚
ã“ã‚Œã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè‡ªä½“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§è§£æ¶ˆã•ã‚Œã¦ã„ãå¯èƒ½æ€§ã¯ã‚ã‚Šã¾ã™ãŒã€ç¾æ™‚ç‚¹ã§ã¯ã€è‡ªå‰ã§å¯¾ç­–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## æ™®é€šã®ç”»é¢é·ç§»

```kotlin:MainFragmentã‹ã‚‰SubFragmentã¸ã®é·ç§»
findNavController().navigate(R.id.action_mainFragment_to_subFragment)
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™å ´åˆ
findNavController().navigate(MainFragmentDirections.actionMainFragmentToSubFragment(params = params))
```

```kotlin:SubFragmentã‹ã‚‰MainFragmentã¸æˆ»ã‚‹å ´åˆã®é·ç§»
findNavController().popBackStack()
// ã¾ãŸã¯
findNavController().popBackStack(R.id.MainFragment, false)
```

ç‰¹ã« popBackStack()ã‚’ä½¿ã£ãŸå ´åˆã¯ã€é€£æ‰“ã™ã‚‹ã¨ NavController å†…ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ BackStack ãŒã‚ºãƒ¬ã‚„ã™ããªã‚Šã¾ã™ã€‚(æˆ»ã‚Šã™ãã‚‹)

## å¯¾ç­–æ¸ˆã¿

Extension ã‚’åˆ©ç”¨ã— Fragment ã«ç”»é¢é·ç§»ç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”Ÿã‚„ã—ã¾ã™ã€‚
(ç”»é¢é·ç§»å‰ã«ãƒ’ã‚¹ãƒˆãƒªã¨ã®æ•´åˆæ€§ç¢ºèªã‚’è¡Œã†å‡¦ç†ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™)

```kotlin:FragmentExtension.kt
package com.sample.extensions

import android.os.Bundle
import androidx.fragment.app.Fragment
import androidx.navigation.*
import androidx.navigation.fragment.DialogFragmentNavigator
import androidx.navigation.fragment.FragmentNavigator
import androidx.navigation.fragment.findNavController

/**
 * ==============================================
 *  Fragment Extensions
 * ==============================================
 */
/**
 * ç¾åœ¨ã®FragmentãŒãƒ’ã‚¹ãƒˆãƒªã®æœ€æ–°ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹
 */
fun Fragment.isCurrentDestination(): Boolean {
  // ãƒ’ã‚¹ãƒˆãƒªã‹ã‚‰ç¾åœ¨ã®Fragmentã®æƒ…å ±ã‚’å–å¾—
  val currentDestination: NavDestination = findNavController().currentDestination ?: return false

  when (currentDestination) {
    is DialogFragmentNavigator.Destination -> {
      if (currentDestination.className != this.javaClass.name) {
        // ãƒ’ã‚¹ãƒˆãƒªä¸Šã®ç¾åœ¨ã®Fragmentã¨ç”»é¢é·ç§»ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸFragmentãŒä¸ä¸€è‡´
        return false
      }
      return true
    }
    is FragmentNavigator.Destination -> {
      if (currentDestination.className != this.javaClass.name) {
        // ãƒ’ã‚¹ãƒˆãƒªä¸Šã®ç¾åœ¨ã®Fragmentã¨ç”»é¢é·ç§»ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸFragmentãŒä¸ä¸€è‡´
        return false
      }
      return true
    }
    else -> {
      return false
    }
  }
}

/**
 * safeNavigate
 */
fun Fragment.safeNavigate(
  resId: Int,
  args: Bundle? = null,
  navOptions: NavOptions? = null,
  navigatorExtras: Navigator.Extras? = null
) {
  if (!isCurrentDestination()) {
    return
  }
  findNavController().apply {
    navigate(resId, args, navOptions, navigatorExtras)
  }
}

/**
 * safeNavigate
 */
fun Fragment.safeNavigate(
  directions: NavDirections,
  navOptions: NavOptions? = null
) {
  safeNavigate(directions.actionId, directions.arguments, navOptions)
}

/**
 * safePopBackStack
 */
fun Fragment.safePopBackStack() {
  if (!isCurrentDestination()) {
    return
  }
  forcePopBackStack()
}

/**
 * forcePopBackStack
 * note:ãƒ’ã‚¹ãƒˆãƒªã¨ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹Fragmentã®ä¸€è‡´ãƒã‚§ãƒƒã‚¯ãªã—ã§æˆ»ã‚‹å‡¦ç†ã‚’è¡Œã†
 *      DialogFragmentã‚’è¡¨ç¤ºå…ƒã®Fragmentã‹ã‚‰éè¡¨ç¤ºã«ã™ã‚‹å ´åˆãªã©ã®åˆ©ç”¨ã‚’æƒ³å®š
 */
fun Fragment.forcePopBackStack() {
  findNavController().apply {
    val navBackStackEntry : NavBackStackEntry =  previousBackStackEntry ?: return
    // ãƒ’ã‚¹ãƒˆãƒªã®1ã¤å‰ã®ç”»é¢ã«æˆ»ã‚‹
    // popBackStack()ã ã¨ã€é€£æ‰“ã«ã‚ˆã‚Š2ã¤å‰ã®ç”»é¢ã¾ã§æˆ»ã£ã¦ã—ã¾ã„ãƒ’ã‚¹ãƒˆãƒªãŒãŠã‹ã—ããªã‚‹ã“ã¨ãŒã‚ã‚‹
    popBackStack(navBackStackEntry.destination.id, false)
  }
}

/**
 * safePopBackStack
 */
fun Fragment.safePopBackStack(
  destinationId: Int,
  inclusive: Boolean
) {
  if (!isCurrentDestination()) {
    return
  }
  findNavController().apply {
    popBackStack(destinationId, inclusive)
  }
}
```

```kotlin:MainFragmentã‹ã‚‰SubFragmentã¸ã®é·ç§»
safeNavigate(R.id.action_mainFragment_to_subFragment)
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™å ´åˆ
safeNavigate(MainFragmentDirections.actionMainFragmentToSubFragment(params = params))
```

```kotlin:SubFragmentã‹ã‚‰MainFragmentã¸æˆ»ã‚‹å ´åˆã®é·ç§»
safePopBackStack()
// ã¾ãŸã¯
safePopBackStack(R.id.MainFragment, false)
```

## ã•ã„ã”ã«

NavigationComponent ã§ã®`IllegalArgumentException`ã‚’æ¤œç´¢ã—ã¦ã¿ã‚‹ã¨ã€
ãƒœã‚¿ãƒ³é€£æ‰“é˜²æ­¢å‡¦ç†ã‚„ã€`navigate`å‰ã®ãƒ’ã‚¹ãƒˆãƒªã¨ã®æ•´åˆæ€§ç¢ºèªãŒã‚ˆãå‡ºã¦ãã¾ã™ãŒã€
ç«¯æœ«ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§ NavController ã‚’æ“ä½œ(popBackStack)ã—ã¦ã„ã‚‹å ´åˆã¯ã€
popBackStack ã«ã‚‚å¯¾ç­–ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸ ğŸ˜“
